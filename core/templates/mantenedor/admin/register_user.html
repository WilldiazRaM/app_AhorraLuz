{% extends "base.html" %}
{% block title %}Registrar Usuario — AhorraLuz{% endblock %}

{% block extra_css %}
<style>
  /* Paleta base */
  :root{
    --brand:#2ecc71;      /* verde principal */
    --brand-600:#27ae60;  /* hover */
    --brand-50:#eafaf1;   /* fondo suave */
    --ink:#212529;
  }

  .admin-wrap{ min-height: 70svh; }
  .admin-card{
    border: 0;
    border-radius: 1rem;
    box-shadow: 0 12px 38px rgba(0,0,0,.08);
    overflow: hidden;
  }
  .admin-header{
    background: linear-gradient(180deg, var(--brand-50), #fff 70%);
    border-bottom: 1px solid rgba(0,0,0,.06);
  }

  .form-label .req {
    color:#d93025; /* rojo accesible para asterisco */
    font-weight: 700;
    margin-left: .25rem;
  }

  .input-group-text {
    background: var(--brand-50);
    border-color: #dee2e6;
  }
  .form-control:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 .25rem rgba(46,204,113,.15);
  }

  .btn-brand{
    background: var(--brand);
    border-color: var(--brand);
    color: #fff;
    transition: transform .06s ease, box-shadow .2s ease;
  }
  .btn-brand:hover { 
    background: var(--brand-600);
    border-color: var(--brand-600);
    transform: translateY(-1px);
    box-shadow: 0 .75rem 1.5rem rgba(39,174,96,.25);
  }
</style>
{% endblock %}

{% block content %}
<div class="container admin-wrap d-flex align-items-start justify-content-center py-4 py-md-5">
  <div class="card admin-card w-100" style="max-width: 1100px;">
    <!-- Encabezado -->
    <div class="admin-header p-4">
      <h1 class="h4 fw-bold mb-1 d-flex align-items-center gap-2">
        <span class="d-inline-flex justify-content-center align-items-center rounded-circle"
              style="width:42px;height:42px;background:#fff;">
          <i class="fa-solid fa-user-plus" style="color:var(--brand);"></i>
        </span>
        Registrar nuevo usuario
      </h1>
      <p class="text-secondary mb-0">Crea cuentas para tu equipo/usuarios finales. Los datos sensibles se guardan cifrados.</p>
    </div>

    <!-- Cuerpo -->
    <div class="card-body p-4 p-md-5">
      <form method="post" novalidate aria-labelledby="formTitle" aria-describedby="formHelp">
        {% csrf_token %}
        <span id="formTitle" class="visually-hidden">Formulario de registro de usuario</span>
        <p id="formHelp" class="visually-hidden">Todos los campos marcados con asterisco son obligatorios.</p>

        <div class="row g-4">
          <!-- Email -->
          <div class="col-12 col-md-6">
            <label for="id_email" class="form-label">Correo electrónico <span class="req" aria-hidden="true">*</span></label>
            <div class="input-group">
              <span class="input-group-text" aria-hidden="true">
                <i class="fa-solid fa-envelope-open-text"></i>
              </span>
              {{ form.email.as_widget|safe }}
            </div>
            {% if form.email.errors %}
              <div class="text-danger small mt-1" role="alert">{{ form.email.errors|striptags }}</div>
            {% else %}
              <div class="form-text">Usado para autenticación. No se compartirá.</div>
            {% endif %}
          </div>

          <!-- Nombres -->
          <div class="col-12 col-md-6">
            <label for="id_nombres" class="form-label">Nombres <span class="req" aria-hidden="true">*</span></label>
            <div class="input-group">
              <span class="input-group-text" aria-hidden="true">
                <i class="fa-solid fa-id-badge"></i>
              </span>
              {{ form.nombres.as_widget|safe }}
            </div>
            {% if form.nombres.errors %}
              <div class="text-danger small mt-1" role="alert">{{ form.nombres.errors|striptags }}</div>
            {% endif %}
          </div>

          <!-- Apellidos -->
          <div class="col-12 col-md-6">
            <label for="id_apellidos" class="form-label">Apellidos <span class="req" aria-hidden="true">*</span></label>
            <div class="input-group">
              <span class="input-group-text" aria-hidden="true">
                <i class="fa-solid fa-user"></i>
              </span>
              {{ form.apellidos.as_widget|safe }}
            </div>
            {% if form.apellidos.errors %}
              <div class="text-danger small mt-1" role="alert">{{ form.apellidos.errors|striptags }}</div>
            {% endif %}
          </div>

          <!-- RUT -->
          <div class="col-12 col-md-6">
            <label for="id_rut" class="form-label">RUT (opcional)</label>
            <div class="input-group">
              <span class="input-group-text" aria-hidden="true">
                <i class="fa-solid fa-id-card-clip"></i>
              </span>
              {{ form.rut.as_widget|safe }}
            </div>
            {% if form.rut.errors %}
              <div class="text-danger small mt-1" role="alert">{{ form.rut.errors|striptags }}</div>
            {% else %}
              <div class="form-text">Se almacena cifrado para proteger la privacidad.</div>
            {% endif %}
          </div>

          <!-- Password -->
          <div class="col-12 col-md-6">
            <label for="id_password" class="form-label">Contraseña <span class="req" aria-hidden="true">*</span></label>
            <div class="input-group">
              <span class="input-group-text" id="icon-password" aria-hidden="true">
                <i class="fa-solid fa-lock"></i>
              </span>
              {{ form.password.as_widget|safe }}
              <button class="btn btn-outline-secondary" type="button" id="togglePassword"
                      aria-label="Mostrar u ocultar contraseña">
                <i class="fa-regular fa-eye" aria-hidden="true"></i>
              </button>
            </div>
            {% if form.password.errors %}
              <div class="text-danger small mt-1" role="alert">{{ form.password.errors|striptags }}</div>
            {% else %}
              <div class="form-text" id="pwdHelp">Usaremos hash bcrypt para almacenarla de forma segura.</div>
            {% endif %}
          </div>
        </div>

        <div class="mt-4 d-flex justify-content-end">
          <button type="submit" class="btn btn-brand btn-lg">
            <i class="fa-solid fa-check me-2"></i>Guardar Usuario
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Mejora de accesibilidad 
  (function(){
    const email = document.getElementById('id_email');
    const nombres = document.getElementById('id_nombres');
    const apellidos = document.getElementById('id_apellidos');
    const rut = document.getElementById('id_rut');
    const pwd = document.getElementById('id_password');

    if(email){ email.placeholder = 'tucorreo@dominio.cl'; email.setAttribute('autocomplete','email'); email.setAttribute('aria-label','Correo electrónico'); }
    if(nombres){ nombres.placeholder = 'Nombre(s)'; nombres.setAttribute('autocomplete','given-name'); nombres.setAttribute('aria-label','Nombres'); }
    if(apellidos){ apellidos.placeholder = 'Apellido(s)'; apellidos.setAttribute('autocomplete','family-name'); apellidos.setAttribute('aria-label','Apellidos'); }
    if(rut){ rut.placeholder = '12345678-9'; rut.setAttribute('aria-label','RUT'); }
    if(pwd){ pwd.placeholder = '••••••••'; pwd.setAttribute('autocomplete','new-password'); pwd.setAttribute('aria-describedby','pwdHelp'); }

    // Toggle password
    const toggle = document.getElementById('togglePassword');
    if(toggle && pwd){
      toggle.addEventListener('click', function(){
        const isPwd = pwd.getAttribute('type') === 'password';
        pwd.setAttribute('type', isPwd ? 'text' : 'password');
        const icon = this.querySelector('i');
        if(icon){ icon.classList.toggle('fa-eye'); icon.classList.toggle('fa-eye-slash'); }
      });
    }
  })();
</script>
{% endblock %}
